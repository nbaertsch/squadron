name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Lint
        run: uv run ruff check src/ tests/

      - name: Format check
        run: uv run ruff format --check src/ tests/

  unit-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12", "3.13"]

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Unit tests
        run: uv run pytest tests/ --ignore=tests/e2e/ -v --tb=short

  # ─── E2E: GitHub API tests ──────────────────────────────────────────
  # Runs tests that use the GitHub App (issue creation, labels, etc.)
  # but do NOT require Copilot SDK authentication.
  #
  # Requires these GitHub Actions secrets:
  #   SQ_APP_ID_DEV              — App ID for squadron-dev
  #   SQ_APP_PRIVATE_KEY         — PEM content (NOT a file path)
  #   SQ_INSTALLATION_ID_DEV     — Installation ID on the test repo
  #
  # And these repository variables (Settings → Secrets and variables → Variables):
  #   E2E_ENABLED                — Set to 'true' to enable this job
  #   E2E_TEST_OWNER             — GitHub owner (org or user)
  #   E2E_TEST_REPO              — Test repository name
  #
  # Tests that need Copilot auth will be skipped automatically via
  # the copilot_authenticated fixture.
  e2e-github:
    runs-on: ubuntu-latest
    needs: unit-tests
    if: >
      github.event_name == 'push'
      && github.ref == 'refs/heads/main'
      && vars.E2E_ENABLED == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Fix Copilot CLI permissions
        run: chmod +x .venv/lib/python*/site-packages/copilot/bin/copilot

      - name: E2E tests (GitHub API — no live LLM)
        run: |
          uv run pytest tests/e2e/ -v --tb=short \
            -m "not live" \
            --ignore=tests/e2e/test_lifecycle_e2e.py
        env:
          SQ_APP_ID_DEV: ${{ secrets.SQ_APP_ID_DEV }}
          SQ_APP_PRIVATE_KEY: ${{ secrets.SQ_APP_PRIVATE_KEY }}
          SQ_INSTALLATION_ID_DEV: ${{ secrets.SQ_INSTALLATION_ID_DEV }}
          E2E_TEST_OWNER: ${{ vars.E2E_TEST_OWNER }}
          E2E_TEST_REPO: ${{ vars.E2E_TEST_REPO }}
          COPILOT_GITHUB_TOKEN: ${{ secrets.SQ_COPILOT_TOKEN }}

  # ─── E2E: Lifecycle tests (live LLM inference) ─────────────────────
  # Full pipeline tests: webhook → PM agent → triage → verify.
  # Uses COPILOT_GITHUB_TOKEN (from SQ_COPILOT_TOKEN secret) for
  # headless Copilot SDK auth. Requires a Copilot-licensed user's PAT.
  e2e-lifecycle:
    runs-on: ubuntu-latest
    needs: e2e-github
    if: >
      github.event_name == 'push'
      && github.ref == 'refs/heads/main'
      && vars.E2E_ENABLED == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Fix Copilot CLI permissions
        run: chmod +x .venv/lib/python*/site-packages/copilot/bin/copilot

      - name: E2E lifecycle tests (live LLM)
        run: |
          uv run pytest tests/e2e/test_lifecycle_e2e.py -v --tb=short
        timeout-minutes: 10
        env:
          SQ_APP_ID_DEV: ${{ secrets.SQ_APP_ID_DEV }}
          SQ_APP_PRIVATE_KEY: ${{ secrets.SQ_APP_PRIVATE_KEY }}
          SQ_INSTALLATION_ID_DEV: ${{ secrets.SQ_INSTALLATION_ID_DEV }}
          E2E_TEST_OWNER: ${{ vars.E2E_TEST_OWNER }}
          E2E_TEST_REPO: ${{ vars.E2E_TEST_REPO }}
          COPILOT_GITHUB_TOKEN: ${{ secrets.SQ_COPILOT_TOKEN }}

  docker:
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=sha
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
