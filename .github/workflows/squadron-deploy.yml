# Squadron Deploy — Azure Container Apps
#
# This workflow manages the full lifecycle of a Squadron deployment:
#   - deploy: infrastructure + new container revision
#   - destroy: tear down all infrastructure
#
# On push to main (any code or config change) → full deploy.
# The container clones the repo at startup so config changes are
# picked up automatically on each new revision.
#
# Manual dispatch: Actions → Squadron Deploy → Run workflow

name: Squadron Deploy

on:
  # ── Manual trigger ─────────────────────────────────────────────────
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        type: choice
        options:
          - deploy
          - destroy
        default: deploy
      resource-group:
        description: "Azure resource group"
        required: false
        default: "squadron-rg"
      location:
        description: "Azure region"
        required: false
        default: "eastus2"
      app-name:
        description: "Container App name (default: <repo>-squadron)"
        required: false
      squadron-image:
        description: "Squadron container image"
        required: false
        default: "ghcr.io/nbaertsch/squadron:latest"

  # ── Auto-deploy on push to main ───────────────────────────────────
  push:
    branches: [main]
    paths:
      - ".squadron/**"
      - "src/**"
      - "Dockerfile"
      - "pyproject.toml"
      - "infra/**"

# ── Permissions ────────────────────────────────────────────────────────────
permissions:
  contents: read

jobs:
  # ════════════════════════════════════════════════════════════════════
  # Deploy infrastructure + new container revision
  # ════════════════════════════════════════════════════════════════════
  deploy:
    if: >
      github.event_name == 'push'
      || (github.event_name == 'workflow_dispatch' && inputs.action == 'deploy')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate .squadron/ exists
        run: |
          if [ ! -f ".squadron/config.yaml" ]; then
            echo "::error::.squadron/config.yaml not found."
            echo "Run 'squadron init' to create it, then commit and push."
            exit 1
          fi
          echo "Found .squadron/config.yaml"

      - name: Determine app name
        id: app
        run: |
          if [ -n "${{ inputs.app-name }}" ]; then
            echo "name=${{ inputs.app-name }}" >> "$GITHUB_OUTPUT"
          else
            REPO_NAME="${{ github.event.repository.name }}"
            echo "name=${REPO_NAME}-squadron" >> "$GITHUB_OUTPUT"
          fi

      - name: Set deployment parameters
        id: params
        run: |
          echo "resource-group=${{ inputs.resource-group || 'squadron-rg' }}" >> "$GITHUB_OUTPUT"
          echo "location=${{ inputs.location || 'eastus2' }}" >> "$GITHUB_OUTPUT"
          echo "image=${{ inputs.squadron-image || 'ghcr.io/nbaertsch/squadron:latest' }}" >> "$GITHUB_OUTPUT"

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # ── Infrastructure ────────────────────────────────────────────
      - name: Create resource group
        run: |
          az group create \
            --name "${{ steps.params.outputs.resource-group }}" \
            --location "${{ steps.params.outputs.location }}" \
            --output none
          echo "Resource group ready: ${{ steps.params.outputs.resource-group }}"

      - name: Deploy infrastructure (Bicep)
        env:
          APP_NAME: ${{ steps.app.outputs.name }}
          IMAGE: ${{ steps.params.outputs.image }}
          LOCATION: ${{ steps.params.outputs.location }}
          REVISION_SUFFIX: run-${{ github.run_id }}
          SQ_APP_ID: ${{ secrets.SQ_APP_ID_DEV }}
          SQ_PRIVATE_KEY: ${{ secrets.SQ_APP_PRIVATE_KEY }}
          SQ_INSTALLATION_ID: ${{ secrets.SQ_INSTALLATION_ID_DEV }}
          SQ_WEBHOOK_SECRET: ${{ secrets.SQ_WEBHOOK_SECRET }}
          SQ_COPILOT_TOKEN: ${{ secrets.SQ_COPILOT_TOKEN }}
        run: |
          set -euo pipefail

          # Write ARM parameters file (handles multiline PEM keys via JSON escaping)
          python3 - <<'PY' > /tmp/squadron-params.json
          import json, os

          def must_get(name: str) -> str:
              v = os.environ.get(name, "")
              if not v:
                  raise SystemExit(f"Missing required secret env var: {name}")
              return v

          doc = {
              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
              "contentVersion": "1.0.0.0",
              "parameters": {
                  "appName": {"value": os.environ["APP_NAME"]},
                  "ghcrImage": {"value": os.environ["IMAGE"]},
                  "location": {"value": os.environ["LOCATION"]},
                  "revisionSuffix": {"value": os.environ.get("REVISION_SUFFIX", "")},
                  "githubAppId": {"value": must_get("SQ_APP_ID")},
                  "githubPrivateKey": {"value": must_get("SQ_PRIVATE_KEY")},
                  "githubInstallationId": {"value": must_get("SQ_INSTALLATION_ID")},
                  "githubWebhookSecret": {"value": must_get("SQ_WEBHOOK_SECRET")},
                  "copilotGithubToken": {"value": os.environ.get("SQ_COPILOT_TOKEN", "")},
              },
          }
          print(json.dumps(doc, indent=2))
          PY

          az deployment group create \
            --name "squadron-infra" \
            --resource-group "${{ steps.params.outputs.resource-group }}" \
            --template-file infra/main.bicep \
            --parameters @/tmp/squadron-params.json \
            --output none

      # ── Clean up old revisions ────────────────────────────────────
      - name: Deactivate old revisions
        run: |
          set -euo pipefail
          APP="${{ steps.app.outputs.name }}"
          RG="${{ steps.params.outputs.resource-group }}"

          az containerapp revision list \
            --name "$APP" --resource-group "$RG" \
            --query "[?properties.active && properties.trafficWeight==\`0\`].name" -o tsv \
          | while read -r rev; do
              echo "  Deactivating: $rev"
              az containerapp revision deactivate \
                --name "$APP" --resource-group "$RG" \
                --revision "$rev" --output none 2>/dev/null || true
            done

          echo "Old revisions deactivated"

      # ── Output ────────────────────────────────────────────────────
      - name: Output deployment info
        run: |
          FQDN=$(az containerapp show \
            --name "${{ steps.app.outputs.name }}" \
            --resource-group "${{ steps.params.outputs.resource-group }}" \
            --query "properties.configuration.ingress.fqdn" --output tsv 2>/dev/null || true)

          if [ -n "$FQDN" ]; then
            echo "## Squadron Deployed" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| | |" >> "$GITHUB_STEP_SUMMARY"
            echo "|---|---|" >> "$GITHUB_STEP_SUMMARY"
            echo "| **App** | \`${{ steps.app.outputs.name }}\` |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **FQDN** | https://${FQDN} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Webhook URL** | \`https://${FQDN}/webhook\` |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Health** | https://${FQDN}/health |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "::warning::Could not determine FQDN."
          fi

      - name: Health check
        run: |
          set -euo pipefail
          FQDN=$(az containerapp show \
            --name "${{ steps.app.outputs.name }}" \
            --resource-group "${{ steps.params.outputs.resource-group }}" \
            --query "properties.configuration.ingress.fqdn" --output tsv 2>/dev/null || true)

          if [ -z "$FQDN" ]; then
            echo "::warning::Cannot health-check — FQDN not available"
            exit 0
          fi

          echo "Waiting for https://${FQDN}/health ..."
          for i in $(seq 1 36); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              --connect-timeout 3 --max-time 5 \
              "https://${FQDN}/health" 2>/dev/null || true)
            if [ "$HTTP_CODE" = "200" ]; then
              echo "Health check passed!"
              curl -s --connect-timeout 3 --max-time 5 "https://${FQDN}/health" | python3 -m json.tool
              exit 0
            fi
            echo "  Attempt $i/36 — HTTP $HTTP_CODE (waiting 10s...)"
            sleep 10
          done

          echo "::error::Health check failed. Dumping diagnostics..."
          timeout 30s az containerapp show \
            --name "${{ steps.app.outputs.name }}" \
            --resource-group "${{ steps.params.outputs.resource-group }}" \
            -o jsonc || true
          timeout 60s az containerapp logs show \
            --name "${{ steps.app.outputs.name }}" \
            --resource-group "${{ steps.params.outputs.resource-group }}" \
            --tail 200 || true
          exit 1

  # ════════════════════════════════════════════════════════════════════
  # Destroy all infrastructure
  # ════════════════════════════════════════════════════════════════════
  destroy:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'destroy'
    runs-on: ubuntu-latest

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Delete resource group
        run: |
          echo "::warning::Destroying all Squadron resources in ${{ inputs.resource-group || 'squadron-rg' }}"
          az group delete \
            --name "${{ inputs.resource-group || 'squadron-rg' }}" \
            --yes --no-wait
          echo "Resource group deletion initiated"
          echo "## Squadron Destroyed" >> "$GITHUB_STEP_SUMMARY"
          echo "Resource group \`${{ inputs.resource-group || 'squadron-rg' }}\` is being deleted." >> "$GITHUB_STEP_SUMMARY"
