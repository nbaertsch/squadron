skills:
  base_path: .squadron/skills
  definitions:
    squadron-internals:
      path: squadron-internals
      description: "Squadron framework architecture, event pipeline, and component design"
    squadron-dev-guide:
      path: squadron-dev-guide
      description: "Coding conventions, async patterns, Pydantic style, and testing practices"
    squadron-tools:
      path: squadron-tools
      description: "Squadron tool registry, signatures, and guide for adding new tools"

agent_roles:
  bug-fix:
    agent_definition: agents/bug-fix.md
    lifecycle: stateful
  docs-dev:
    agent_definition: agents/docs-dev.md
    lifecycle: stateful
  feat-dev:
    agent_definition: agents/feat-dev.md
    lifecycle: stateful
    subagents:
    - code-search
    - test-writer
  infra-dev:
    agent_definition: agents/infra-dev.md
    lifecycle: stateful
  merge-conflict:
    agent_definition: agents/merge-conflict.md
    lifecycle: ephemeral
  pm:
    agent_definition: agents/pm.md
    lifecycle: ephemeral
    singleton: true
    subagents:
    - feat-dev
    - bug-fix
    - pr-review
    - security-review
    - docs-dev
    - infra-dev
  pr-review:
    agent_definition: agents/pr-review.md
    lifecycle: stateful
  security-review:
    agent_definition: agents/security-review.md
    lifecycle: stateful
  test-coverage:
    agent_definition: agents/test-coverage.md
    lifecycle: stateful
branch_naming:
  bugfix: fix/issue-{issue_number}
  chore: chore/{description}
  docs: docs/issue-{issue_number}
  feature: feat/issue-{issue_number}
  hotfix: hotfix/issue-{issue_number}
  infra: infra/issue-{issue_number}
  security: security/issue-{issue_number}
circuit_breakers:
  defaults:
    max_active_duration: 7200
    max_iterations: 5
    max_sleep_duration: 86400
    max_tool_calls: 200
    max_turns: 50
    warning_threshold: 0.8
  roles:
    pm:
      max_active_duration: 600
      max_tool_calls: 50
      max_turns: 10
    pr-review:
      max_active_duration: 1800
      max_tool_calls: 100
      max_turns: 20
    security-review:
      max_active_duration: 1800
      max_tool_calls: 100
      max_turns: 20
    test-coverage:
      max_active_duration: 1800
      max_tool_calls: 100
      max_turns: 20
    infra-dev:
      max_active_duration: 10800  # 3 hours - infrastructure work can be complex
      max_tool_calls: 200
      max_turns: 50
commands:
  help:
    enabled: true
    invoke_agent: false
    response: '## Squadron Commands


      Available commands:

      - `@squadron-dev help` - Show this help message

      - `@squadron-dev status` - Show project status


      For more information, see the Squadron documentation.

      '
  status:
    delegate_to: pm
    enabled: true
    invoke_agent: true
escalation:
  default_notify: maintainers
  escalation_labels:
  - needs-human
  - escalation
  max_issue_depth: 3
human_groups:
  maintainers:
  - '@noahbaertsch'
human_invocation:
  include_context: true
  labels_to_add:
  - needs-human
  mention_format: '@{username}'
  method: both
labels:
  priorities:
  - critical
  - high
  - medium
  - low
  states:
  - needs-triage
  - in-progress
  - blocked
  - needs-human
  - needs-clarification
  types:
  - feature
  - bug
  - security
  - documentation
  - infrastructure
project:
  bot_username: squadron-dev[bot]
  default_branch: squadron-dev
  name: squadron
  owner: nbaertsch
  repo: squadron

# ─── PIPELINES ───────────────────────────────────────────────────────────────────
# AD-019: Unified pipeline system — replaces triggers, review_policy, and workflows
pipelines:

  # ── Issue Triage ─────────────────────────────────────────────────────────────
  # Replaces: pm agent_role triggers (issues.opened, issues.reopened)
  issue-triage:
    description: "Spawn PM agent to triage new and reopened issues"
    trigger:
      event: issues.opened
    stages:
      - id: triage
        type: agent
        agent: pm
        action: "Triage this issue: assess priority, assign labels, and determine next steps"
        timeout: 10m
        on_error:
          retry: 1
          then: escalate

  issue-reopen-triage:
    description: "Spawn PM agent to re-triage reopened issues"
    trigger:
      event: issues.reopened
    stages:
      - id: triage
        type: agent
        agent: pm
        action: "Re-triage this reopened issue: reassess priority and determine next steps"
        timeout: 10m
        on_error:
          retry: 1
          then: escalate

  # ── Bug Fix Lifecycle ────────────────────────────────────────────────────────
  # Replaces: bug-fix agent_role triggers
  bug-fix-lifecycle:
    description: "Full bug fix lifecycle from issue label to PR merge"
    scope: issue
    trigger:
      event: issues.labeled
      conditions:
        label: bug
    on_events:
      pull_request_review.submitted:
        action: wake_agent
      issue_comment.created:
        action: wake_agent
      pull_request.closed:
        action: wake_agent
    stages:
      - id: fix-bug
        type: agent
        agent: bug-fix
        action: "Investigate and fix this bug, then open a PR with the fix"
        timeout: 2h
        on_error:
          retry: 1
          then: escalate

  # ── Feature Development Lifecycle ────────────────────────────────────────────
  # Replaces: feat-dev agent_role triggers
  feature-dev-lifecycle:
    description: "Full feature development lifecycle from issue label to PR merge"
    scope: issue
    trigger:
      event: issues.labeled
      conditions:
        label: feature
    on_events:
      pull_request_review.submitted:
        action: wake_agent
      issue_comment.created:
        action: wake_agent
      pull_request.closed:
        action: wake_agent
    stages:
      - id: implement
        type: agent
        agent: feat-dev
        action: "Implement this feature and open a PR"
        timeout: 2h
        on_error:
          retry: 1
          then: escalate

  # ── Documentation Lifecycle ──────────────────────────────────────────────────
  # Replaces: docs-dev agent_role triggers
  docs-dev-lifecycle:
    description: "Documentation development lifecycle from issue label to PR merge"
    scope: issue
    trigger:
      event: issues.labeled
      conditions:
        label: documentation
    on_events:
      pull_request_review.submitted:
        action: wake_agent
      pull_request.closed:
        action: wake_agent
    stages:
      - id: write-docs
        type: agent
        agent: docs-dev
        action: "Write or update documentation as described in this issue"
        timeout: 1h
        on_error:
          retry: 1
          then: escalate

  # ── Security Issue Lifecycle ─────────────────────────────────────────────────
  # Replaces: security-review agent_role trigger on issues.labeled:security
  security-issue-lifecycle:
    description: "Security issue investigation and remediation"
    scope: issue
    trigger:
      event: issues.labeled
      conditions:
        label: security
    on_events:
      pull_request_review.submitted:
        action: wake_agent
      pull_request.closed:
        action: wake_agent
    stages:
      - id: investigate
        type: agent
        agent: security-review
        action: "Investigate this security issue and implement a fix"
        timeout: 1h
        on_error:
          retry: 1
          then: escalate

  # ── PR Lifecycle ─────────────────────────────────────────────────────────────
  # Replaces: review_policy (default_requirements, rules, on_synchronize, auto_merge)
  #           + pr-review/security-review/test-coverage triggers on PR events
  pr-lifecycle:
    description: "PR review, approval gates, and auto-merge pipeline"
    scope: single-pr
    trigger:
      event: pull_request.opened
      conditions:
        base_branch: squadron-dev
    on_events:
      pull_request.synchronize:
        action: invalidate_and_restart
        invalidate:
          - security-review
          - code-review
        restart_from: test-coverage
      pull_request_review.submitted:
        action: reevaluate_gates
      check_suite.completed:
        action: reevaluate_gates
      pull_request.closed:
        action: cancel
    stages:
      # Stage 1: Test coverage review (from squadron-dev-pipeline sequence)
      - id: test-coverage
        type: agent
        agent: test-coverage
        action: "Review test coverage for this PR"
        timeout: 30m
        on_complete: security-review
        on_error:
          retry: 1
          then: escalate

      # Stage 2: Security review — conditional on security-sensitive paths/labels
      - id: security-review
        type: agent
        agent: security-review
        action: "Perform security review of this PR"
        condition:
          any:
            - labels_include: security
            - paths_match:
                - "src/**/auth/**"
                - "src/**/crypto/**"
                - "**/security/**"
        skip_to: code-review
        timeout: 30m
        on_complete: code-review
        on_error:
          retry: 1
          then: escalate

      # Stage 3: Code review
      - id: code-review
        type: agent
        agent: pr-review
        action: "Perform code review of this PR"
        timeout: 30m
        on_complete: approval-gate
        on_error:
          retry: 1
          then: escalate

      # Stage 4: Approval gate — all agent reviews must approve
      - id: approval-gate
        type: gate
        conditions:
          - check: pr_approvals_met
            count: 1
          - check: no_changes_requested
        on_pass: auto-merge
        on_fail:
          goto: code-review
          max_iterations: 3
          then: escalate
        timeout: 48h
        on_timeout:
          notify:
            target: maintainers
            message: "PR approval gate timed out after 48h"
          then: escalate

      # Stage 5: Auto-merge
      - id: auto-merge
        type: action
        action: merge_pr
        config:
          method: squash
          delete_branch: true
        on_error:
          retry: 1
          then: escalate

    on_complete:
      - type: comment
        body: "Pipeline complete — PR merged to squadron-dev."

    on_error:
      - type: label
        add: needs-human
      - type: comment
        body: "PR lifecycle pipeline encountered an error. Human review required."

  # ── Feature Dev Pipeline (multi-stage with quality gates) ────────────────────
  # Replaces: workflows.feature-dev-pipeline
  feature-dev-pipeline:
    description: "Multi-stage feature development with quality gates"
    scope: issue
    trigger:
      event: issues.labeled
      conditions:
        label: feature-pipeline
    context:
      require_tests: true
      test_coverage_threshold: 80
    stages:
      - id: plan
        type: agent
        agent: pm
        action: "Create implementation plan for this feature"
        on_complete: implement
        timeout: 10m
        on_error:
          retry: 1
          then: escalate

      - id: implement
        type: agent
        agent: feat-dev
        action: "Implement the feature according to the plan"
        timeout: 2h
        on_complete: quality-gate
        on_error:
          retry: 1
          then: escalate

      - id: quality-gate
        type: gate
        conditions:
          - check: command
            run: python -m pytest tests/
            expect: "exit_code == 0"
        on_pass: complete
        on_fail:
          goto: implement
          max_iterations: 3
          then: escalate

    on_complete:
      - type: comment
        body: "Feature implementation complete and all quality gates passed."

    on_error:
      - type: label
        add: needs-human
      - type: comment
        body: "Feature pipeline encountered an error. Human review required."

runtime:
  default_model: claude-sonnet-4.6
  models:
    bug-fix:
      model: claude-sonnet-4.6
    feat-dev:
      model: claude-sonnet-4.6
    pm:
      model: claude-sonnet-4.6
    pr-review:
      model: claude-sonnet-4.6
    security-review:
      model: claude-sonnet-4.6
    test-coverage:
      model: claude-sonnet-4.6
  provider:
    type: copilot
  reconciliation_interval: 300

sandbox:
  enabled: true  # Requires Linux kernel >= 3.8 (namespace isolation)
  # Namespace isolation (native Linux kernel, no third-party deps)
  namespace_mount: true
  namespace_pid: true
  namespace_net: true
  namespace_ipc: true
  namespace_uts: true
  seccomp_enabled: true
  # Worktree isolation
  use_overlayfs: true
  # Data retention -- Azure File Share mount point
  retention_path: /mnt/squadron-data/forensics
  retention_days: 1
  # Resource limits (cgroups v2)
  memory_limit_mb: 2048
  cpu_quota_percent: 200
  disk_limit_mb: 5120
  session_timeout: 7200
  # Tool proxy
  socket_dir: /tmp/squadron-sockets
  max_tool_calls_per_session: 200
  timing_floor_ms: 50
  # Inspection
  output_inspection_enabled: true
  diff_inspection_enabled: true
  block_sensitive_path_changes: true
  sensitive_paths:
    - ".github/**"
    - "Makefile"
    - "*.sh"
    - "pyproject.toml"
    - "Dockerfile"
    - "docker-compose*.yml"
    - "infra/**"
    - "deploy/**"
    - ".pre-commit-config.yaml"
