# .squadron/config.yaml — Squadron project configuration
# See docs/project-plan/research/config-schema.md for full reference.

# ─────────────────────────────────────────────
# Project Identity
# ─────────────────────────────────────────────
project:
  name: "squadron"
  owner: "nbaertsch"
  repo: "squadron"
  default_branch: squadron-dev
  bot_username: "squadron-dev[bot]"

# ─────────────────────────────────────────────
# Label Taxonomy
# ─────────────────────────────────────────────
labels:
  types:
    - feature
    - bug
    - security
    - documentation
    - infrastructure
  priorities:
    - critical
    - high
    - medium
    - low
  states:
    - needs-triage
    - in-progress
    - blocked
    - needs-human
    - needs-clarification

# ─────────────────────────────────────────────
# Branch Naming Conventions
# ─────────────────────────────────────────────
branch_naming:
  feature: "feat/issue-{issue_number}"
  bugfix: "fix/issue-{issue_number}"
  security: "security/issue-{issue_number}"
  docs: "docs/issue-{issue_number}"
  infra: "infra/issue-{issue_number}"
  hotfix: "hotfix/issue-{issue_number}"
  chore: "chore/{description}"

# ─────────────────────────────────────────────
# Human Groups
# ─────────────────────────────────────────────
human_groups:
  maintainers: ["@noahbaertsch"]

# ─────────────────────────────────────────────
# Agent Roles
# ─────────────────────────────────────────────
agent_roles:
  pm:
    agent_definition: agents/pm.md
    singleton: true
    lifecycle: ephemeral
    triggers:
      - event: "issues.opened"
      - event: "issues.reopened"
      # Comments are routed via @pm / /pm mentions (Layer 2 routing).
      # No issue_comment.created trigger needed — mention routing handles it.
    subagents: [feat-dev, bug-fix, pr-review, security-review, docs-dev, infra-dev]

  feat-dev:
    agent_definition: agents/feat-dev.md
    triggers:
      - event: "issues.labeled"
        label: feature
      - event: "pull_request.opened"
        action: sleep
      - event: "pull_request_review.submitted"
        condition: {review_state: "changes_requested"}
        action: wake
      - event: "pull_request.closed"
        condition: {merged: false}
        action: wake
      - event: "pull_request.closed"
        condition: {merged: true}
        action: complete
    subagents: [code-search, test-writer]

  bug-fix:
    agent_definition: agents/bug-fix.md
    triggers:
      - event: "issues.labeled"
        label: bug
      - event: "pull_request.opened"
        action: sleep
      - event: "pull_request_review.submitted"
        condition: {review_state: "changes_requested"}
        action: wake
      - event: "pull_request.closed"
        condition: {merged: false}
        action: wake
      - event: "pull_request.closed"
        condition: {merged: true}
        action: complete

  pr-review:
    agent_definition: agents/pr-review.md
    triggers:
      - event: "pull_request.opened"
        condition: {approval_flow: true}
      - event: "pull_request.synchronize"
        action: wake
      - event: "pull_request.closed"
        action: complete

  security-review:
    agent_definition: agents/security-review.md
    triggers:
      - event: "issues.labeled"
        label: security
      - event: "pull_request.opened"
        condition: {approval_flow: true}
      - event: "pull_request.synchronize"
        action: wake
      - event: "pull_request.closed"
        action: complete

  docs-dev:
    agent_definition: agents/docs-dev.md
    triggers:
      - event: "issues.labeled"
        label: documentation
      - event: "pull_request.opened"
        action: sleep
      - event: "pull_request_review.submitted"
        condition: {review_state: "changes_requested"}
        action: wake
      - event: "pull_request.closed"
        condition: {merged: true}
        action: complete

  infra-dev:
    agent_definition: agents/infra-dev.md
    triggers:
      - event: "issues.labeled"
        label: infrastructure
      - event: "pull_request.opened"
        action: sleep
      - event: "pull_request_review.submitted"
        condition: {review_state: "changes_requested"}
        action: wake
      - event: "pull_request.closed"
        condition: {merged: true}
        action: complete

  test-coverage:
    agent_definition: agents/test-coverage.md

  merge-conflict:
    agent_definition: agents/merge-conflict.md
    lifecycle: ephemeral
    # No triggers - spawned programmatically by auto-merge failure handler

# ─────────────────────────────────────────────
# Circuit Breakers
# ─────────────────────────────────────────────
circuit_breakers:
  defaults:
    max_iterations: 5
    max_tool_calls: 200
    max_turns: 50
    max_active_duration: 7200    # 2 hours
    max_sleep_duration: 86400    # 24 hours
    warning_threshold: 0.80

  roles:
    pm:
      max_tool_calls: 50
      max_turns: 10
      max_active_duration: 600   # 10 minutes
    pr-review:
      max_tool_calls: 100
      max_turns: 20
      max_active_duration: 1800  # 30 minutes
    security-review:
      max_tool_calls: 100
      max_turns: 20
      max_active_duration: 1800  # 30 minutes
    test-coverage:
      max_tool_calls: 100
      max_turns: 20
      max_active_duration: 1800  # 30 minutes

# ─────────────────────────────────────────────
# Runtime / LLM Configuration
# ─────────────────────────────────────────────
runtime:
  default_model: "claude-sonnet-4"
  # NOTE: reasoning_effort is NOT supported by claude-sonnet-4 via the
  # Copilot SDK.  Omit per-role overrides until model support is added.

  models:
    pm:
      model: "claude-sonnet-4"
    feat-dev:
      model: "claude-sonnet-4"
    bug-fix:
      model: "claude-sonnet-4"
    pr-review:
      model: "claude-sonnet-4"
    security-review:
      model: "claude-sonnet-4"
    test-coverage:
      model: "claude-sonnet-4"

  # Provider: "copilot" uses the SDK's built-in Copilot auth (default).
  # For BYOK (bring-your-own-key), set type to "anthropic" or "openai"
  # and supply api_key_env pointing to an env var with the key.
  provider:
    type: "copilot"

  reconciliation_interval: 300   # 5 minutes

# ─────────────────────────────────────────────
# Escalation / Notifications
# ─────────────────────────────────────────────
escalation:
  default_notify: maintainers
  escalation_labels:
    - needs-human
    - escalation
  max_issue_depth: 3

# ─────────────────────────────────────────────
# Review Policy (replaces approval_flows + workflows)
# ─────────────────────────────────────────────
review_policy:
  enabled: true

  # Auto-merge configuration
  auto_merge:
    enabled: true
    method: squash
    delete_branch: true
    require_ci_pass: false  # Set to true when CI is configured

    # What to do when merge fails
    on_merge_conflict:
      action: notify
      target: maintainers
    on_ci_failed:
      action: notify
      target: maintainers
    on_unknown_error:
      action: escalate
      target: maintainers

  # What happens when a PR is updated after reviews
  on_synchronize:
    invalidate_approvals: true  # Full re-review required
    respawn_reviewers: true     # Wake reviewer agents

  # Default requirements for ALL PRs
  default_requirements:
    - role: pr-review
      count: 1

  # Conditional rules (additive with defaults)
  rules:
    - name: security-sensitive
      match:
        labels: [security]
        paths:
          - "src/**/auth/**"
          - "src/**/crypto/**"
          - "**/security/**"
      requirements:
        - role: security-review
          count: 1

    - name: infrastructure
      match:
        labels: [infrastructure]
        paths:
          - ".squadron/**"
          - "pyproject.toml"
          - "Dockerfile"
          - ".github/**"
      requirements:
        - role: pr-review
          count: 1

    # Sequential review pipeline for PRs targeting squadron-dev
    # Replaces the old .squadron/workflows/pr-review-pipeline.yaml
    - name: squadron-dev-pipeline
      match:
        base_branch: squadron-dev
      requirements:
        - role: test-coverage
          count: 1
        - role: security-review
          count: 1
        - role: pr-review
          count: 1
      sequence:
        - test-coverage
        - security-review
        - pr-review

# ─────────────────────────────────────────────
# Human Invocation (how to notify humans)
# ─────────────────────────────────────────────
human_invocation:
  method: both  # github_comment, issue_label, or both
  mention_format: "@{username}"
  include_context: true
  labels_to_add:
    - needs-human

# NOTE: approval_flows section removed — superseded by review_policy above
