# Squadron Deploy — Azure Container Apps
#
# TEMPLATE: Copy this file to your repo at .github/workflows/squadron-deploy.yml
#
# This workflow manages the full lifecycle of a Squadron deployment:
#   - Initial infrastructure deployment (Azure Container Apps via Bicep)
#   - Config sync when .squadron/ changes
#   - Infrastructure teardown
#
# Prerequisites:
#   1. GitHub App installed on this repo
#   2. Repository secrets configured (see deploy/azure-container-apps/README.md)
#
# Usage:
#   - Manual dispatch: Actions → Squadron Deploy → Run workflow
#   - Auto sync: push changes to .squadron/** on main

name: Squadron Deploy

on:
  # ── Manual trigger ─────────────────────────────────────────────────
  workflow_dispatch:
    inputs:
      action:
        description: "Action to perform"
        required: true
        type: choice
        options:
          - deploy
          - sync-config
          - destroy
        default: deploy
      resource-group:
        description: "Azure resource group"
        required: false
        default: "squadron-rg"
      location:
        description: "Azure region"
        required: false
        default: "eastus"
      app-name:
        description: "Container App name (default: <repo>-squadron)"
        required: false
      squadron-image:
        description: "Squadron container image"
        required: false
        default: "ghcr.io/nbaertsch/squadron:latest"

  # ── Auto-sync on config changes ───────────────────────────────────
  push:
    branches: [main]
    paths:
      - ".squadron/**"

# ── Permissions ────────────────────────────────────────────────────────────
permissions:
  contents: read

# ── Environment ────────────────────────────────────────────────────────────
env:
  # Pin the Squadron infrastructure template version
  # Change to a release tag for stability (e.g. v0.1.0)
  SQUADRON_REF: "main"

jobs:
  # ════════════════════════════════════════════════════════════════════
  # Deploy infrastructure + sync config
  # ════════════════════════════════════════════════════════════════════
  deploy:
    if: >
      github.event_name == 'push'
      || (github.event_name == 'workflow_dispatch' && inputs.action == 'deploy')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate .squadron/ exists
        run: |
          if [ ! -d ".squadron" ]; then
            echo "::error::.squadron/ directory not found."
            echo "Copy examples/.squadron/ from the Squadron repo into your repo root, then commit and push."
            exit 1
          fi
          if [ ! -f ".squadron/config.yaml" ]; then
            echo "::error::.squadron/config.yaml not found."
            exit 1
          fi
          echo "Found .squadron/ with config.yaml"
          ls -la .squadron/

      - name: Determine app name
        id: app
        run: |
          if [ -n "${{ inputs.app-name }}" ]; then
            echo "name=${{ inputs.app-name }}" >> "$GITHUB_OUTPUT"
          else
            REPO_NAME="${{ github.event.repository.name }}"
            echo "name=${REPO_NAME}-squadron" >> "$GITHUB_OUTPUT"
          fi

      - name: Set deployment parameters
        id: params
        run: |
          echo "resource-group=${{ inputs.resource-group || 'squadron-rg' }}" >> "$GITHUB_OUTPUT"
          echo "location=${{ inputs.location || 'eastus' }}" >> "$GITHUB_OUTPUT"
          echo "image=${{ inputs.squadron-image || 'ghcr.io/nbaertsch/squadron:latest' }}" >> "$GITHUB_OUTPUT"

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # ── Infrastructure (only on full deploy) ──────────────────────
      - name: Download Squadron Bicep template
        if: github.event_name == 'workflow_dispatch' && inputs.action == 'deploy'
        run: |
          curl -sfL \
            "https://raw.githubusercontent.com/nbaertsch/squadron/${{ env.SQUADRON_REF }}/infra/main.bicep" \
            -o /tmp/squadron-infra.bicep
          echo "Downloaded Bicep template (ref: ${{ env.SQUADRON_REF }})"

      - name: Create resource group
        if: github.event_name == 'workflow_dispatch' && inputs.action == 'deploy'
        run: |
          az group create \
            --name "${{ steps.params.outputs.resource-group }}" \
            --location "${{ steps.params.outputs.location }}" \
            --output none
          echo "Resource group ready: ${{ steps.params.outputs.resource-group }}"

      - name: Deploy infrastructure (Bicep)
        if: github.event_name == 'workflow_dispatch' && inputs.action == 'deploy'
        id: bicep
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: ${{ steps.params.outputs.resource-group }}
          template: /tmp/squadron-infra.bicep
          parameters: >-
            appName=${{ steps.app.outputs.name }}
            ghcrImage=${{ steps.params.outputs.image }}
            location=${{ steps.params.outputs.location }}
            githubAppId=${{ secrets.SQ_APP_ID }}
            githubPrivateKey=${{ secrets.SQ_PRIVATE_KEY }}
            githubInstallationId=${{ secrets.SQ_INSTALLATION_ID }}
            githubWebhookSecret=${{ secrets.SQ_WEBHOOK_SECRET }}
            copilotGithubToken=${{ secrets.SQ_COPILOT_TOKEN }}
            repoUrl=https://github.com/${{ github.repository }}

      # ── Config sync (push to main with .squadron/ changes) ────────
      # The container clones the repo at startup and hot-reloads config
      # on push events (D-5). For push-triggered runs, restart the
      # container so it picks up the latest commit.
      - name: Restart container for config sync
        if: github.event_name == 'push'
        run: |
          APP_NAME="${{ steps.app.outputs.name }}"
          RG="${{ steps.params.outputs.resource-group }}"

          REVISION=$(az containerapp revision list \
            --name "$APP_NAME" \
            --resource-group "$RG" \
            --query "[0].name" --output tsv 2>/dev/null || true)

          if [ -n "$REVISION" ]; then
            az containerapp revision restart \
              --name "$APP_NAME" \
              --resource-group "$RG" \
              --revision "$REVISION" \
              --output none
            echo "Container restarted to pick up config changes"
          else
            echo "::warning::No active revision found — deploy infrastructure first."
          fi

      # ── Output ────────────────────────────────────────────────────
      - name: Output deployment info
        run: |
          FQDN=$(az containerapp show \
            --name "${{ steps.app.outputs.name }}" \
            --resource-group "${{ steps.params.outputs.resource-group }}" \
            --query "properties.configuration.ingress.fqdn" --output tsv 2>/dev/null || true)

          if [ -n "$FQDN" ]; then
            echo "## Squadron Deployed" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| | |" >> "$GITHUB_STEP_SUMMARY"
            echo "|---|---|" >> "$GITHUB_STEP_SUMMARY"
            echo "| **App** | \`${{ steps.app.outputs.name }}\` |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **FQDN** | https://${FQDN} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Webhook URL** | \`https://${FQDN}/webhook\` |" >> "$GITHUB_STEP_SUMMARY"
            echo "| **Health** | https://${FQDN}/health |" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Next Steps" >> "$GITHUB_STEP_SUMMARY"
            echo "1. Set the **Webhook URL** in your [GitHub App settings](https://github.com/settings/apps):" >> "$GITHUB_STEP_SUMMARY"
            echo "   \`https://${FQDN}/webhook\`" >> "$GITHUB_STEP_SUMMARY"
            echo "2. Verify health: \`curl https://${FQDN}/health\`" >> "$GITHUB_STEP_SUMMARY"
            echo "3. Open an issue to test!" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "::warning::Could not determine FQDN. Check if the container app exists."
          fi

      - name: Health check
        run: |
          FQDN=$(az containerapp show \
            --name "${{ steps.app.outputs.name }}" \
            --resource-group "${{ steps.params.outputs.resource-group }}" \
            --query "properties.configuration.ingress.fqdn" --output tsv 2>/dev/null || true)

          if [ -z "$FQDN" ]; then
            echo "::warning::Cannot health-check — FQDN not available"
            exit 0
          fi

          echo "Waiting for https://${FQDN}/health ..."
          for i in $(seq 1 12); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://${FQDN}/health" 2>/dev/null || true)
            if [ "$HTTP_CODE" = "200" ]; then
              echo "Health check passed!"
              curl -s "https://${FQDN}/health" | python3 -m json.tool
              exit 0
            fi
            echo "  Attempt $i/12 — HTTP $HTTP_CODE (waiting 10s...)"
            sleep 10
          done
          echo "::warning::Health check did not pass within 120s. Container may still be starting."

  # ════════════════════════════════════════════════════════════════════
  # Sync config only (restart container to git pull latest)
  # ════════════════════════════════════════════════════════════════════
  sync-config:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'sync-config'
    runs-on: ubuntu-latest

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Determine app name
        id: app
        run: |
          if [ -n "${{ inputs.app-name }}" ]; then
            echo "name=${{ inputs.app-name }}" >> "$GITHUB_OUTPUT"
          else
            REPO_NAME="${{ github.event.repository.name }}"
            echo "name=${REPO_NAME}-squadron" >> "$GITHUB_OUTPUT"
          fi

      - name: Restart container to pick up latest config
        run: |
          RG="${{ inputs.resource-group || 'squadron-rg' }}"
          REVISION=$(az containerapp revision list \
            --name "${{ steps.app.outputs.name }}" \
            --resource-group "$RG" \
            --query "[0].name" --output tsv)
          az containerapp revision restart \
            --name "${{ steps.app.outputs.name }}" \
            --resource-group "$RG" \
            --revision "$REVISION" \
            --output none
          echo "Container restarting — will git pull and reload config"

  # ════════════════════════════════════════════════════════════════════
  # Destroy all infrastructure
  # ════════════════════════════════════════════════════════════════════
  destroy:
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'destroy'
    runs-on: ubuntu-latest

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Confirm destruction
        run: |
          echo "::warning::Destroying all Squadron resources in ${{ inputs.resource-group }}"
          echo "This will delete the Container App, storage, and all data."

      - name: Delete resource group
        run: |
          az group delete \
            --name "${{ inputs.resource-group || 'squadron-rg' }}" \
            --yes --no-wait
          echo "Resource group deletion initiated (async)"
          echo "## Squadron Destroyed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Resource group \`${{ inputs.resource-group || 'squadron-rg' }}\` is being deleted." >> "$GITHUB_STEP_SUMMARY"
