name: PR Cleanup

# This workflow handles post-merge cleanup for Squadron PRs:
# 1. Delete merged feature branches
# 2. Close issues that were fixed by the PR (if referenced)
# 3. Notify agents of successful PR completion

on:
  pull_request:
    types: [closed]
    branches: [main, squadron-dev]

permissions:
  contents: write        # For deleting branches
  issues: write         # For closing issues
  pull-requests: write  # For commenting on PRs

jobs:
  cleanup:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: Extract issue numbers from PR body
        id: extract_issues
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          
          # Extract issue numbers using multiple patterns
          ISSUE_NUMS=$(echo "$PR_BODY" | grep -oiE '(close[sd]?|fix(e[sd]?)?|resolve[sd]?)\s*#([0-9]+)' | grep -oE '[0-9]+' | sort -u | tr '\n' ' ')
          
          # Also check for simple #N references in branch name or title
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          if echo "$BRANCH_NAME" | grep -qE 'issue-[0-9]+'; then
            BRANCH_ISSUE=$(echo "$BRANCH_NAME" | grep -oE '[0-9]+' | head -1)
            ISSUE_NUMS="$ISSUE_NUMS $BRANCH_ISSUE"
          fi
          
          # Remove duplicates and format
          ISSUE_NUMS=$(echo "$ISSUE_NUMS" | tr ' ' '\n' | sort -u | tr '\n' ' ' | sed 's/[[:space:]]*$//')
          
          echo "Found issues: $ISSUE_NUMS"
          echo "issue_numbers=$ISSUE_NUMS" >> $GITHUB_OUTPUT

      - name: Close referenced issues
        if: steps.extract_issues.outputs.issue_numbers != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumbers = '${{ steps.extract_issues.outputs.issue_numbers }}'.split(' ').filter(n => n);
            const prNumber = ${{ github.event.pull_request.number }};
            const prTitle = '${{ github.event.pull_request.title }}';
            
            for (const issueNum of issueNumbers) {
              try {
                // Get issue to check if it's still open
                const { data: issue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNum)
                });
                
                if (issue.state === 'open') {
                  // Close the issue
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNum),
                    state: 'closed'
                  });
                  
                  // Post completion comment
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNum),
                    body: `ðŸŽ‰ **Completed** â€” This issue was resolved by PR #${prNumber}: ${prTitle}\n\nThe implementation has been merged and the feature branch has been cleaned up.`
                  });
                  
                  console.log(`Closed issue #${issueNum}`);
                } else {
                  console.log(`Issue #${issueNum} already closed`);
                }
              } catch (error) {
                console.log(`Failed to process issue #${issueNum}: ${error.message}`);
              }
            }

      - name: Delete merged branch
        if: github.event.pull_request.head.ref != 'main' && github.event.pull_request.head.ref != 'squadron-dev'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ github.event.pull_request.head.ref }}';
            
            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branchName}`
              });
              console.log(`Deleted branch: ${branchName}`);
            } catch (error) {
              console.log(`Failed to delete branch ${branchName}: ${error.message}`);
              // Don't fail the job - branch might already be deleted
            }

      - name: Post success comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const branchName = '${{ github.event.pull_request.head.ref }}';
            const issueNumbers = '${{ steps.extract_issues.outputs.issue_numbers }}';
            
            let message = `âœ… **PR merged successfully!**\n\n`;
            message += `- Branch \`${branchName}\` has been cleaned up\n`;
            
            if (issueNumbers) {
              const issues = issueNumbers.split(' ').filter(n => n).map(n => `#${n}`).join(', ');
              message += `- Related issues closed: ${issues}\n`;
            }
            
            message += `\nAll Squadron agents associated with this PR have been notified of completion.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: message
            });
